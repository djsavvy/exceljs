{"version":3,"file":"iterate-stream.js","names":["module","exports","_iterateStream","_wrapAsyncGenerator","stream","contents","on","data","push","resolveStreamEndedPromise","streamEndedPromise","Promise","resolve","ended","error","err","length","resume","_awaitAsyncGenerator","race","once","pause","shift","iterateStream","_x","apply","arguments","eventEmitter","type","fired","handler","removeListener","addListener"],"sources":["../../../lib/utils/iterate-stream.js"],"sourcesContent":["module.exports = async function* iterateStream(stream) {\r\n  const contents = [];\r\n  stream.on('data', data => contents.push(data));\r\n\r\n  let resolveStreamEndedPromise;\r\n  const streamEndedPromise = new Promise(resolve => (resolveStreamEndedPromise = resolve));\r\n\r\n  let ended = false;\r\n  stream.on('end', () => {\r\n    ended = true;\r\n    resolveStreamEndedPromise();\r\n  });\r\n\r\n  let error = false;\r\n  stream.on('error', err => {\r\n    error = err;\r\n    resolveStreamEndedPromise();\r\n  });\r\n\r\n  while (!ended || contents.length > 0) {\r\n    if (contents.length === 0) {\r\n      stream.resume();\r\n      // eslint-disable-next-line no-await-in-loop\r\n      await Promise.race([once(stream, 'data'), streamEndedPromise]);\r\n    } else {\r\n      stream.pause();\r\n      const data = contents.shift();\r\n      yield data;\r\n    }\r\n    if (error) throw error;\r\n  }\r\n  resolveStreamEndedPromise();\r\n};\r\n\r\nfunction once(eventEmitter, type) {\r\n  // TODO: Use require('events').once when node v10 is dropped\r\n  return new Promise(resolve => {\r\n    let fired = false;\r\n    const handler = () => {\r\n      if (!fired) {\r\n        fired = true;\r\n        eventEmitter.removeListener(type, handler);\r\n        resolve();\r\n      }\r\n    };\r\n    eventEmitter.addListener(type, handler);\r\n  });\r\n}\r\n"],"mappings":";;;;;;;AAAAA,MAAM,CAACC,OAAO;EAAA,IAAAC,cAAA,GAAAC,mBAAA,CAAG,WAA8BC,MAAM,EAAE;IACrD,MAAMC,QAAQ,GAAG,EAAE;IACnBD,MAAM,CAACE,EAAE,CAAC,MAAM,EAAEC,IAAI,IAAIF,QAAQ,CAACG,IAAI,CAACD,IAAI,CAAC,CAAC;IAE9C,IAAIE,yBAAyB;IAC7B,MAAMC,kBAAkB,GAAG,IAAIC,OAAO,CAACC,OAAO,IAAKH,yBAAyB,GAAGG,OAAQ,CAAC;IAExF,IAAIC,KAAK,GAAG,KAAK;IACjBT,MAAM,CAACE,EAAE,CAAC,KAAK,EAAE,MAAM;MACrBO,KAAK,GAAG,IAAI;MACZJ,yBAAyB,CAAC,CAAC;IAC7B,CAAC,CAAC;IAEF,IAAIK,KAAK,GAAG,KAAK;IACjBV,MAAM,CAACE,EAAE,CAAC,OAAO,EAAES,GAAG,IAAI;MACxBD,KAAK,GAAGC,GAAG;MACXN,yBAAyB,CAAC,CAAC;IAC7B,CAAC,CAAC;IAEF,OAAO,CAACI,KAAK,IAAIR,QAAQ,CAACW,MAAM,GAAG,CAAC,EAAE;MACpC,IAAIX,QAAQ,CAACW,MAAM,KAAK,CAAC,EAAE;QACzBZ,MAAM,CAACa,MAAM,CAAC,CAAC;QACf;QACA,MAAAC,oBAAA,CAAMP,OAAO,CAACQ,IAAI,CAAC,CAACC,IAAI,CAAChB,MAAM,EAAE,MAAM,CAAC,EAAEM,kBAAkB,CAAC,CAAC;MAChE,CAAC,MAAM;QACLN,MAAM,CAACiB,KAAK,CAAC,CAAC;QACd,MAAMd,IAAI,GAAGF,QAAQ,CAACiB,KAAK,CAAC,CAAC;QAC7B,MAAMf,IAAI;MACZ;MACA,IAAIO,KAAK,EAAE,MAAMA,KAAK;IACxB;IACAL,yBAAyB,CAAC,CAAC;EAC7B,CAAC;EAAA,SAhCgCc,aAAaA,CAAAC,EAAA;IAAA,OAAAtB,cAAA,CAAAuB,KAAA,OAAAC,SAAA;EAAA;EAAA,OAAbH,aAAa;AAAA,GAgC7C;AAED,SAASH,IAAIA,CAACO,YAAY,EAAEC,IAAI,EAAE;EAChC;EACA,OAAO,IAAIjB,OAAO,CAACC,OAAO,IAAI;IAC5B,IAAIiB,KAAK,GAAG,KAAK;IACjB,MAAMC,OAAO,GAAGA,CAAA,KAAM;MACpB,IAAI,CAACD,KAAK,EAAE;QACVA,KAAK,GAAG,IAAI;QACZF,YAAY,CAACI,cAAc,CAACH,IAAI,EAAEE,OAAO,CAAC;QAC1ClB,OAAO,CAAC,CAAC;MACX;IACF,CAAC;IACDe,YAAY,CAACK,WAAW,CAACJ,IAAI,EAAEE,OAAO,CAAC;EACzC,CAAC,CAAC;AACJ","ignoreList":[]}
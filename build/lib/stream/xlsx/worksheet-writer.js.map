{"version":3,"file":"worksheet-writer.js","names":["_","require","RelType","colCache","Encryptor","Dimensions","StringBuf","Row","Column","SheetRelsWriter","SheetCommentsWriter","DataValidations","xmlBuffer","ListXform","DataValidationsXform","SheetPropertiesXform","SheetFormatPropertiesXform","ColXform","RowXform","HyperlinkXform","SheetViewXform","SheetProtectionXform","PageMarginsXform","PageSetupXform","AutoFilterXform","PictureXform","ConditionalFormattingsXform","HeaderFooterXform","RowBreaksXform","xform","dataValidations","sheetProperties","sheetFormatProperties","columns","tag","length","childXform","row","hyperlinks","sheetViews","sheetProtection","pageMargins","pageSeteup","autoFilter","picture","conditionalFormattings","headerFooter","rowBreaks","WorksheetWriter","constructor","options","id","name","concat","state","_rows","_columns","_keys","_merges","add","_sheetRelsWriter","_sheetCommentsWriter","_dimensions","_rowZero","committed","_formulae","_siFormulae","conditionalFormatting","properties","Object","assign","defaultRowHeight","dyDescent","outlineLevelCol","outlineLevelRow","differentFirst","differentOddEven","oddHeader","oddFooter","evenHeader","evenFooter","firstHeader","firstFooter","pageSetup","margins","left","right","top","bottom","header","footer","orientation","horizontalDpi","verticalDpi","fitToPage","fitToWidth","fitToHeight","scale","pageOrder","blackAndWhite","draft","cellComments","errors","paperSize","undefined","showRowColHeaders","showGridLines","horizontalCentered","verticalCentered","colBreaks","useSharedStrings","_workbook","workbook","hasComments","_views","views","_media","_writeOpenWorksheet","startedData","stream","_stream","_openStream","pause","destroy","Error","commit","forEach","cRow","_writeRow","_writeOpenSheetData","_writeCloseSheetData","_writeAutoFilter","_writeMergeCells","_writeHyperlinks","_writeConditionalFormatting","_writeDataValidations","_writeSheetProtection","_writePageMargins","_writePageSetup","_writeBackground","_writeHeaderFooter","_writeRowBreaks","_writeLegacyData","_writeCloseWorksheet","end","dimensions","value","_headerRowCount","reduce","pv","cv","headerCount","headers","Math","max","count","defn","column","push","getColumnKey","key","setColumnKey","deleteColumnKey","eachColumnKey","f","each","getColumn","c","col","l2n","n","_nextRow","eachRow","iteratee","includeEmpty","i","getRow","hasValues","number","_commitRow","found","shift","lastRow","findRow","rowNumber","index","addRow","values","findCell","r","address","getAddress","getCell","getCellEx","mergeCells","_len","arguments","cells","Array","_key","merge","intersects","master","j","addConditionalFormatting","cf","removeConditionalFormatting","filter","splice","Function","addBackgroundImage","imageId","_background","getBackgroundImageId","protect","password","Promise","resolve","sheet","spinCount","Number","isFinite","round","algorithmName","saltValue","randomBytes","toString","hashValue","convertPasswordToHash","unprotect","_write","text","reset","addText","write","_writeSheetProperties","xmlBuf","sheetPropertiesModel","outlineProperties","tabColor","toXml","_writeSheetFormatProperties","sheetFormatPropertiesModel","defaultColWidth","_writeColumns","cols","toModel","prepare","styles","height","model","sharedStrings","hyperlinksProxy","merges","formulae","siFormulae","comments","addComments","_hyperlinks","image","getImage","pictureId","addMedia","Target","Type","Image","_objectSpread","rId","vmlRelId","_writeDimensions","module","exports"],"sources":["../../../../lib/stream/xlsx/worksheet-writer.js"],"sourcesContent":["const _ = require('../../utils/under-dash');\r\n\r\nconst RelType = require('../../xlsx/rel-type');\r\n\r\nconst colCache = require('../../utils/col-cache');\r\nconst Encryptor = require('../../utils/encryptor');\r\nconst Dimensions = require('../../doc/range');\r\nconst StringBuf = require('../../utils/string-buf');\r\n\r\nconst Row = require('../../doc/row');\r\nconst Column = require('../../doc/column');\r\n\r\nconst SheetRelsWriter = require('./sheet-rels-writer');\r\nconst SheetCommentsWriter = require('./sheet-comments-writer');\r\nconst DataValidations = require('../../doc/data-validations');\r\n\r\nconst xmlBuffer = new StringBuf();\r\n\r\n// ============================================================================================\r\n// Xforms\r\nconst ListXform = require('../../xlsx/xform/list-xform');\r\nconst DataValidationsXform = require('../../xlsx/xform/sheet/data-validations-xform');\r\nconst SheetPropertiesXform = require('../../xlsx/xform/sheet/sheet-properties-xform');\r\nconst SheetFormatPropertiesXform = require('../../xlsx/xform/sheet/sheet-format-properties-xform');\r\nconst ColXform = require('../../xlsx/xform/sheet/col-xform');\r\nconst RowXform = require('../../xlsx/xform/sheet/row-xform');\r\nconst HyperlinkXform = require('../../xlsx/xform/sheet/hyperlink-xform');\r\nconst SheetViewXform = require('../../xlsx/xform/sheet/sheet-view-xform');\r\nconst SheetProtectionXform = require('../../xlsx/xform/sheet/sheet-protection-xform');\r\nconst PageMarginsXform = require('../../xlsx/xform/sheet/page-margins-xform');\r\nconst PageSetupXform = require('../../xlsx/xform/sheet/page-setup-xform');\r\nconst AutoFilterXform = require('../../xlsx/xform/sheet/auto-filter-xform');\r\nconst PictureXform = require('../../xlsx/xform/sheet/picture-xform');\r\nconst ConditionalFormattingsXform = require('../../xlsx/xform/sheet/cf/conditional-formattings-xform');\r\nconst HeaderFooterXform = require('../../xlsx/xform/sheet/header-footer-xform');\r\nconst RowBreaksXform = require('../../xlsx/xform/sheet/row-breaks-xform');\r\n\r\n// since prepare and render are functional, we can use singletons\r\nconst xform = {\r\n  dataValidations: new DataValidationsXform(),\r\n  sheetProperties: new SheetPropertiesXform(),\r\n  sheetFormatProperties: new SheetFormatPropertiesXform(),\r\n  columns: new ListXform({tag: 'cols', length: false, childXform: new ColXform()}),\r\n  row: new RowXform(),\r\n  hyperlinks: new ListXform({tag: 'hyperlinks', length: false, childXform: new HyperlinkXform()}),\r\n  sheetViews: new ListXform({tag: 'sheetViews', length: false, childXform: new SheetViewXform()}),\r\n  sheetProtection: new SheetProtectionXform(),\r\n  pageMargins: new PageMarginsXform(),\r\n  pageSeteup: new PageSetupXform(),\r\n  autoFilter: new AutoFilterXform(),\r\n  picture: new PictureXform(),\r\n  conditionalFormattings: new ConditionalFormattingsXform(),\r\n  headerFooter: new HeaderFooterXform(),\r\n  rowBreaks: new RowBreaksXform(),\r\n};\r\n\r\n// ============================================================================================\r\n\r\nclass WorksheetWriter {\r\n  constructor(options) {\r\n    // in a workbook, each sheet will have a number\r\n    this.id = options.id;\r\n\r\n    // and a name\r\n    this.name = options.name || `Sheet${this.id}`;\r\n\r\n    // add a state\r\n    this.state = options.state || 'visible';\r\n\r\n    // rows are stored here while they need to be worked on.\r\n    // when they are committed, they will be deleted.\r\n    this._rows = [];\r\n\r\n    // column definitions\r\n    this._columns = null;\r\n\r\n    // column keys (addRow convenience): key ==> this._columns index\r\n    this._keys = {};\r\n\r\n    // keep a record of all row and column pageBreaks\r\n    this._merges = [];\r\n    this._merges.add = function() {}; // ignore cell instruction\r\n\r\n    // keep record of all hyperlinks\r\n    this._sheetRelsWriter = new SheetRelsWriter(options);\r\n\r\n    this._sheetCommentsWriter = new SheetCommentsWriter(this, this._sheetRelsWriter, options);\r\n\r\n    // keep a record of dimensions\r\n    this._dimensions = new Dimensions();\r\n\r\n    // first uncommitted row\r\n    this._rowZero = 1;\r\n\r\n    // committed flag\r\n    this.committed = false;\r\n\r\n    // for data validations\r\n    this.dataValidations = new DataValidations();\r\n\r\n    // for sharing formulae\r\n    this._formulae = {};\r\n    this._siFormulae = 0;\r\n\r\n    // keep a record of conditionalFormattings\r\n    this.conditionalFormatting = [];\r\n\r\n    // keep a record of all row and column pageBreaks\r\n    this.rowBreaks = [];\r\n\r\n    // for default row height, outline levels, etc\r\n    this.properties = Object.assign(\r\n      {},\r\n      {\r\n        defaultRowHeight: 15,\r\n        dyDescent: 55,\r\n        outlineLevelCol: 0,\r\n        outlineLevelRow: 0,\r\n      },\r\n      options.properties\r\n    );\r\n\r\n    this.headerFooter = Object.assign(\r\n      {},\r\n      {\r\n        differentFirst: false,\r\n        differentOddEven: false,\r\n        oddHeader: null,\r\n        oddFooter: null,\r\n        evenHeader: null,\r\n        evenFooter: null,\r\n        firstHeader: null,\r\n        firstFooter: null,\r\n      },\r\n      options.headerFooter\r\n    );\r\n\r\n    // for all things printing\r\n    this.pageSetup = Object.assign(\r\n      {},\r\n      {\r\n        margins: {left: 0.7, right: 0.7, top: 0.75, bottom: 0.75, header: 0.3, footer: 0.3},\r\n        orientation: 'portrait',\r\n        horizontalDpi: 4294967295,\r\n        verticalDpi: 4294967295,\r\n        fitToPage: !!(\r\n          options.pageSetup &&\r\n          (options.pageSetup.fitToWidth || options.pageSetup.fitToHeight) &&\r\n          !options.pageSetup.scale\r\n        ),\r\n        pageOrder: 'downThenOver',\r\n        blackAndWhite: false,\r\n        draft: false,\r\n        cellComments: 'None',\r\n        errors: 'displayed',\r\n        scale: 100,\r\n        fitToWidth: 1,\r\n        fitToHeight: 1,\r\n        paperSize: undefined,\r\n        showRowColHeaders: false,\r\n        showGridLines: false,\r\n        horizontalCentered: false,\r\n        verticalCentered: false,\r\n        rowBreaks: null,\r\n        colBreaks: null,\r\n      },\r\n      options.pageSetup\r\n    );\r\n\r\n    // using shared strings creates a smaller xlsx file but may use more memory\r\n    this.useSharedStrings = options.useSharedStrings || false;\r\n\r\n    this._workbook = options.workbook;\r\n\r\n    this.hasComments = false;\r\n\r\n    // views\r\n    this._views = options.views || [];\r\n\r\n    // auto filter\r\n    this.autoFilter = options.autoFilter || null;\r\n\r\n    this._media = [];\r\n\r\n    // worksheet protection\r\n    this.sheetProtection = null;\r\n\r\n    // start writing to stream now\r\n    this._writeOpenWorksheet();\r\n\r\n    this.startedData = false;\r\n  }\r\n\r\n  get workbook() {\r\n    return this._workbook;\r\n  }\r\n\r\n  get stream() {\r\n    if (!this._stream) {\r\n      // eslint-disable-next-line no-underscore-dangle\r\n      this._stream = this._workbook._openStream(`/xl/worksheets/sheet${this.id}.xml`);\r\n\r\n      // pause stream to prevent 'data' events\r\n      this._stream.pause();\r\n    }\r\n    return this._stream;\r\n  }\r\n\r\n  // destroy - not a valid operation for a streaming writer\r\n  // even though some streamers might be able to, it's a bad idea.\r\n  destroy() {\r\n    throw new Error('Invalid Operation: destroy');\r\n  }\r\n\r\n  commit() {\r\n    if (this.committed) {\r\n      return;\r\n    }\r\n    // commit all rows\r\n    this._rows.forEach(cRow => {\r\n      if (cRow) {\r\n        // write the row to the stream\r\n        this._writeRow(cRow);\r\n      }\r\n    });\r\n\r\n    // we _cannot_ accept new rows from now on\r\n    this._rows = null;\r\n\r\n    if (!this.startedData) {\r\n      this._writeOpenSheetData();\r\n    }\r\n    this._writeCloseSheetData();\r\n    this._writeAutoFilter();\r\n    this._writeMergeCells();\r\n\r\n    // for some reason, Excel can't handle dimensions at the bottom of the file\r\n    // this._writeDimensions();\r\n\r\n    this._writeHyperlinks();\r\n    this._writeConditionalFormatting();\r\n    this._writeDataValidations();\r\n    this._writeSheetProtection();\r\n    this._writePageMargins();\r\n    this._writePageSetup();\r\n    this._writeBackground();\r\n    this._writeHeaderFooter();\r\n    this._writeRowBreaks();\r\n\r\n    // Legacy Data tag for comments\r\n    this._writeLegacyData();\r\n\r\n    this._writeCloseWorksheet();\r\n    // signal end of stream to workbook\r\n    this.stream.end();\r\n\r\n    this._sheetCommentsWriter.commit();\r\n    // also commit the hyperlinks if any\r\n    this._sheetRelsWriter.commit();\r\n\r\n    this.committed = true;\r\n  }\r\n\r\n  // return the current dimensions of the writer\r\n  get dimensions() {\r\n    return this._dimensions;\r\n  }\r\n\r\n  get views() {\r\n    return this._views;\r\n  }\r\n\r\n  // =========================================================================\r\n  // Columns\r\n\r\n  // get the current columns array.\r\n  get columns() {\r\n    return this._columns;\r\n  }\r\n\r\n  // set the columns from an array of column definitions.\r\n  // Note: any headers defined will overwrite existing values.\r\n  set columns(value) {\r\n    // calculate max header row count\r\n    this._headerRowCount = value.reduce((pv, cv) => {\r\n      const headerCount = (cv.header && 1) || (cv.headers && cv.headers.length) || 0;\r\n      return Math.max(pv, headerCount);\r\n    }, 0);\r\n\r\n    // construct Column objects\r\n    let count = 1;\r\n    const columns = (this._columns = []);\r\n    value.forEach(defn => {\r\n      const column = new Column(this, count++, false);\r\n      columns.push(column);\r\n      column.defn = defn;\r\n    });\r\n  }\r\n\r\n  getColumnKey(key) {\r\n    return this._keys[key];\r\n  }\r\n\r\n  setColumnKey(key, value) {\r\n    this._keys[key] = value;\r\n  }\r\n\r\n  deleteColumnKey(key) {\r\n    delete this._keys[key];\r\n  }\r\n\r\n  eachColumnKey(f) {\r\n    _.each(this._keys, f);\r\n  }\r\n\r\n  // get a single column by col number. If it doesn't exist, it and any gaps before it\r\n  // are created.\r\n  getColumn(c) {\r\n    if (typeof c === 'string') {\r\n      // if it matches a key'd column, return that\r\n      const col = this._keys[c];\r\n      if (col) return col;\r\n\r\n      // otherwise, assume letter\r\n      c = colCache.l2n(c);\r\n    }\r\n    if (!this._columns) {\r\n      this._columns = [];\r\n    }\r\n    if (c > this._columns.length) {\r\n      let n = this._columns.length + 1;\r\n      while (n <= c) {\r\n        this._columns.push(new Column(this, n++));\r\n      }\r\n    }\r\n    return this._columns[c - 1];\r\n  }\r\n\r\n  // =========================================================================\r\n  // Rows\r\n  get _nextRow() {\r\n    return this._rowZero + this._rows.length;\r\n  }\r\n\r\n  // iterate over every uncommitted row in the worksheet, including maybe empty rows\r\n  eachRow(options, iteratee) {\r\n    if (!iteratee) {\r\n      iteratee = options;\r\n      options = undefined;\r\n    }\r\n    if (options && options.includeEmpty) {\r\n      const n = this._nextRow;\r\n      for (let i = this._rowZero; i < n; i++) {\r\n        iteratee(this.getRow(i), i);\r\n      }\r\n    } else {\r\n      this._rows.forEach(row => {\r\n        if (row.hasValues) {\r\n          iteratee(row, row.number);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  _commitRow(cRow) {\r\n    // since rows must be written in order, we commit all rows up till and including cRow\r\n    let found = false;\r\n    while (this._rows.length && !found) {\r\n      const row = this._rows.shift();\r\n      this._rowZero++;\r\n      if (row) {\r\n        this._writeRow(row);\r\n        found = row.number === cRow.number;\r\n        this._rowZero = row.number + 1;\r\n      }\r\n    }\r\n  }\r\n\r\n  get lastRow() {\r\n    // returns last uncommitted row\r\n    if (this._rows.length) {\r\n      return this._rows[this._rows.length - 1];\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  // find a row (if exists) by row number\r\n  findRow(rowNumber) {\r\n    const index = rowNumber - this._rowZero;\r\n    return this._rows[index];\r\n  }\r\n\r\n  getRow(rowNumber) {\r\n    const index = rowNumber - this._rowZero;\r\n\r\n    // may fail if rows have been comitted\r\n    if (index < 0) {\r\n      throw new Error('Out of bounds: this row has been committed');\r\n    }\r\n    let row = this._rows[index];\r\n    if (!row) {\r\n      this._rows[index] = row = new Row(this, rowNumber);\r\n    }\r\n    return row;\r\n  }\r\n\r\n  addRow(value) {\r\n    const row = new Row(this, this._nextRow);\r\n    this._rows[row.number - this._rowZero] = row;\r\n    row.values = value;\r\n    return row;\r\n  }\r\n\r\n  // ================================================================================\r\n  // Cells\r\n\r\n  // returns the cell at [r,c] or address given by r. If not found, return undefined\r\n  findCell(r, c) {\r\n    const address = colCache.getAddress(r, c);\r\n    const row = this.findRow(address.row);\r\n    return row ? row.findCell(address.column) : undefined;\r\n  }\r\n\r\n  // return the cell at [r,c] or address given by r. If not found, create a new one.\r\n  getCell(r, c) {\r\n    const address = colCache.getAddress(r, c);\r\n    const row = this.getRow(address.row);\r\n    return row.getCellEx(address);\r\n  }\r\n\r\n  mergeCells(...cells) {\r\n    // may fail if rows have been comitted\r\n    const dimensions = new Dimensions(cells);\r\n\r\n    // check cells aren't already merged\r\n    this._merges.forEach(merge => {\r\n      if (merge.intersects(dimensions)) {\r\n        throw new Error('Cannot merge already merged cells');\r\n      }\r\n    });\r\n\r\n    // apply merge\r\n    const master = this.getCell(dimensions.top, dimensions.left);\r\n    for (let i = dimensions.top; i <= dimensions.bottom; i++) {\r\n      for (let j = dimensions.left; j <= dimensions.right; j++) {\r\n        if (i > dimensions.top || j > dimensions.left) {\r\n          this.getCell(i, j).merge(master);\r\n        }\r\n      }\r\n    }\r\n\r\n    // index merge\r\n    this._merges.push(dimensions);\r\n  }\r\n\r\n  // ===========================================================================\r\n  // Conditional Formatting\r\n  addConditionalFormatting(cf) {\r\n    this.conditionalFormatting.push(cf);\r\n  }\r\n\r\n  removeConditionalFormatting(filter) {\r\n    if (typeof filter === 'number') {\r\n      this.conditionalFormatting.splice(filter, 1);\r\n    } else if (filter instanceof Function) {\r\n      this.conditionalFormatting = this.conditionalFormatting.filter(filter);\r\n    } else {\r\n      this.conditionalFormatting = [];\r\n    }\r\n  }\r\n\r\n  // =========================================================================\r\n\r\n  addBackgroundImage(imageId) {\r\n    this._background = {\r\n      imageId,\r\n    };\r\n  }\r\n\r\n  getBackgroundImageId() {\r\n    return this._background && this._background.imageId;\r\n  }\r\n\r\n  // =========================================================================\r\n  // Worksheet Protection\r\n  protect(password, options) {\r\n    // TODO: make this function truly async\r\n    // perhaps marshal to worker thread or something\r\n    return new Promise(resolve => {\r\n      this.sheetProtection = {\r\n        sheet: true,\r\n      };\r\n      if (options && 'spinCount' in options) {\r\n        // force spinCount to be integer >= 0\r\n        options.spinCount = Number.isFinite(options.spinCount) ? Math.round(Math.max(0, options.spinCount)) : 100000;\r\n      }\r\n      if (password) {\r\n        this.sheetProtection.algorithmName = 'SHA-512';\r\n        this.sheetProtection.saltValue = Encryptor.randomBytes(16).toString('base64');\r\n        this.sheetProtection.spinCount = options && 'spinCount' in options ? options.spinCount : 100000; // allow user specified spinCount\r\n        this.sheetProtection.hashValue = Encryptor.convertPasswordToHash(\r\n          password,\r\n          'SHA512',\r\n          this.sheetProtection.saltValue,\r\n          this.sheetProtection.spinCount\r\n        );\r\n      }\r\n      if (options) {\r\n        this.sheetProtection = Object.assign(this.sheetProtection, options);\r\n        if (!password && 'spinCount' in options) {\r\n          delete this.sheetProtection.spinCount;\r\n        }\r\n      }\r\n      resolve();\r\n    });\r\n  }\r\n\r\n  unprotect() {\r\n    this.sheetProtection = null;\r\n  }\r\n\r\n  // ================================================================================\r\n\r\n  _write(text) {\r\n    xmlBuffer.reset();\r\n    xmlBuffer.addText(text);\r\n    this.stream.write(xmlBuffer);\r\n  }\r\n\r\n  _writeSheetProperties(xmlBuf, properties, pageSetup) {\r\n    const sheetPropertiesModel = {\r\n      outlineProperties: properties && properties.outlineProperties,\r\n      tabColor: properties && properties.tabColor,\r\n      pageSetup:\r\n        pageSetup && pageSetup.fitToPage\r\n          ? {\r\n              fitToPage: pageSetup.fitToPage,\r\n            }\r\n          : undefined,\r\n    };\r\n\r\n    xmlBuf.addText(xform.sheetProperties.toXml(sheetPropertiesModel));\r\n  }\r\n\r\n  _writeSheetFormatProperties(xmlBuf, properties) {\r\n    const sheetFormatPropertiesModel = properties\r\n      ? {\r\n          defaultRowHeight: properties.defaultRowHeight,\r\n          dyDescent: properties.dyDescent,\r\n          outlineLevelCol: properties.outlineLevelCol,\r\n          outlineLevelRow: properties.outlineLevelRow,\r\n        }\r\n      : undefined;\r\n    if (properties.defaultColWidth) {\r\n      sheetFormatPropertiesModel.defaultColWidth = properties.defaultColWidth;\r\n    }\r\n\r\n    xmlBuf.addText(xform.sheetFormatProperties.toXml(sheetFormatPropertiesModel));\r\n  }\r\n\r\n  _writeOpenWorksheet() {\r\n    xmlBuffer.reset();\r\n\r\n    xmlBuffer.addText('<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>');\r\n    xmlBuffer.addText(\r\n      '<worksheet xmlns=\"http://schemas.openxmlformats.org/spreadsheetml/2006/main\"' +\r\n        ' xmlns:r=\"http://schemas.openxmlformats.org/officeDocument/2006/relationships\"' +\r\n        ' xmlns:mc=\"http://schemas.openxmlformats.org/markup-compatibility/2006\"' +\r\n        ' mc:Ignorable=\"x14ac\"' +\r\n        ' xmlns:x14ac=\"http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac\">'\r\n    );\r\n\r\n    this._writeSheetProperties(xmlBuffer, this.properties, this.pageSetup);\r\n\r\n    xmlBuffer.addText(xform.sheetViews.toXml(this.views));\r\n\r\n    this._writeSheetFormatProperties(xmlBuffer, this.properties);\r\n\r\n    this.stream.write(xmlBuffer);\r\n  }\r\n\r\n  _writeColumns() {\r\n    const cols = Column.toModel(this.columns);\r\n    if (cols) {\r\n      xform.columns.prepare(cols, {styles: this._workbook.styles});\r\n      this.stream.write(xform.columns.toXml(cols));\r\n    }\r\n  }\r\n\r\n  _writeOpenSheetData() {\r\n    this._write('<sheetData>');\r\n  }\r\n\r\n  _writeRow(row) {\r\n    if (!this.startedData) {\r\n      this._writeColumns();\r\n      this._writeOpenSheetData();\r\n      this.startedData = true;\r\n    }\r\n\r\n    if (row.hasValues || row.height) {\r\n      const {model} = row;\r\n      const options = {\r\n        styles: this._workbook.styles,\r\n        sharedStrings: this.useSharedStrings ? this._workbook.sharedStrings : undefined,\r\n        hyperlinks: this._sheetRelsWriter.hyperlinksProxy,\r\n        merges: this._merges,\r\n        formulae: this._formulae,\r\n        siFormulae: this._siFormulae,\r\n        comments: [],\r\n      };\r\n      xform.row.prepare(model, options);\r\n      this.stream.write(xform.row.toXml(model));\r\n\r\n      if (options.comments.length) {\r\n        this.hasComments = true;\r\n        this._sheetCommentsWriter.addComments(options.comments);\r\n      }\r\n    }\r\n  }\r\n\r\n  _writeCloseSheetData() {\r\n    this._write('</sheetData>');\r\n  }\r\n\r\n  _writeMergeCells() {\r\n    if (this._merges.length) {\r\n      xmlBuffer.reset();\r\n      xmlBuffer.addText(`<mergeCells count=\"${this._merges.length}\">`);\r\n      this._merges.forEach(merge => {\r\n        xmlBuffer.addText(`<mergeCell ref=\"${merge}\"/>`);\r\n      });\r\n      xmlBuffer.addText('</mergeCells>');\r\n\r\n      this.stream.write(xmlBuffer);\r\n    }\r\n  }\r\n\r\n  _writeHyperlinks() {\r\n    // eslint-disable-next-line no-underscore-dangle\r\n    this.stream.write(xform.hyperlinks.toXml(this._sheetRelsWriter._hyperlinks));\r\n  }\r\n\r\n  _writeConditionalFormatting() {\r\n    const options = {\r\n      styles: this._workbook.styles,\r\n    };\r\n    xform.conditionalFormattings.prepare(this.conditionalFormatting, options);\r\n    this.stream.write(xform.conditionalFormattings.toXml(this.conditionalFormatting));\r\n  }\r\n\r\n  _writeRowBreaks() {\r\n    this.stream.write(xform.rowBreaks.toXml(this.rowBreaks));\r\n  }\r\n\r\n  _writeDataValidations() {\r\n    this.stream.write(xform.dataValidations.toXml(this.dataValidations.model));\r\n  }\r\n\r\n  _writeSheetProtection() {\r\n    this.stream.write(xform.sheetProtection.toXml(this.sheetProtection));\r\n  }\r\n\r\n  _writePageMargins() {\r\n    this.stream.write(xform.pageMargins.toXml(this.pageSetup.margins));\r\n  }\r\n\r\n  _writePageSetup() {\r\n    this.stream.write(xform.pageSeteup.toXml(this.pageSetup));\r\n  }\r\n\r\n  _writeHeaderFooter() {\r\n    this.stream.write(xform.headerFooter.toXml(this.headerFooter));\r\n  }\r\n\r\n  _writeAutoFilter() {\r\n    this.stream.write(xform.autoFilter.toXml(this.autoFilter));\r\n  }\r\n\r\n  _writeBackground() {\r\n    if (this._background) {\r\n      if (this._background.imageId !== undefined) {\r\n        const image = this._workbook.getImage(this._background.imageId);\r\n        const pictureId = this._sheetRelsWriter.addMedia({\r\n          Target: `../media/${image.name}`,\r\n          Type: RelType.Image,\r\n        });\r\n\r\n        this._background = {\r\n          ...this._background,\r\n          rId: pictureId,\r\n        };\r\n      }\r\n      this.stream.write(xform.picture.toXml({rId: this._background.rId}));\r\n    }\r\n  }\r\n\r\n  _writeLegacyData() {\r\n    if (this.hasComments) {\r\n      xmlBuffer.reset();\r\n      xmlBuffer.addText(`<legacyDrawing r:id=\"${this._sheetCommentsWriter.vmlRelId}\"/>`);\r\n      this.stream.write(xmlBuffer);\r\n    }\r\n  }\r\n\r\n  _writeDimensions() {\r\n    // for some reason, Excel can't handle dimensions at the bottom of the file\r\n    // and we don't know the dimensions until the commit, so don't write them.\r\n    // this._write('<dimension ref=\"' + this._dimensions + '\"/>');\r\n  }\r\n\r\n  _writeCloseWorksheet() {\r\n    this._write('</worksheet>');\r\n  }\r\n}\r\n\r\nmodule.exports = WorksheetWriter;\r\n"],"mappings":"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","ignoreList":[]}
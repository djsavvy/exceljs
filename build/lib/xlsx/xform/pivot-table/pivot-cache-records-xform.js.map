{"version":3,"file":"pivot-cache-records-xform.js","names":["XmlStream","require","BaseXform","PivotCacheRecordsXform","constructor","map","prepare","model","tag","render","xmlStream","sourceSheet","cacheFields","sourceBodyRows","getSheetValues","slice","openXml","StdDocAttributes","openNode","_objectSpread","PIVOT_CACHE_RECORDS_ATTRIBUTES","count","length","writeXml","renderTable","closeNode","rowsInXML","row","realRow","renderRowLines","join","index","cellValue","entries","renderCell","sharedItems","value","Number","isFinite","concat","sharedItemsIndex","indexOf","Error","JSON","stringify","parseOpen","node","parseText","text","parseClose","name","reconcile","options","xmlns","module","exports"],"sources":["../../../../../lib/xlsx/xform/pivot-table/pivot-cache-records-xform.js"],"sourcesContent":["const XmlStream = require('../../../utils/xml-stream');\r\n\r\nconst BaseXform = require('../base-xform');\r\n\r\nclass PivotCacheRecordsXform extends BaseXform {\r\n  constructor() {\r\n    super();\r\n\r\n    this.map = {};\r\n  }\r\n\r\n  prepare(model) {\r\n    // TK\r\n  }\r\n\r\n  get tag() {\r\n    // http://www.datypic.com/sc/ooxml/e-ssml_pivotCacheRecords.html\r\n    return 'pivotCacheRecords';\r\n  }\r\n\r\n  render(xmlStream, model) {\r\n    const {sourceSheet, cacheFields} = model;\r\n    const sourceBodyRows = sourceSheet.getSheetValues().slice(2);\r\n\r\n    xmlStream.openXml(XmlStream.StdDocAttributes);\r\n    xmlStream.openNode(this.tag, {\r\n      ...PivotCacheRecordsXform.PIVOT_CACHE_RECORDS_ATTRIBUTES,\r\n      count: sourceBodyRows.length,\r\n    });\r\n    xmlStream.writeXml(renderTable());\r\n    xmlStream.closeNode();\r\n\r\n    // Helpers\r\n\r\n    function renderTable() {\r\n      const rowsInXML = sourceBodyRows.map(row => {\r\n        const realRow = row.slice(1);\r\n        return [...renderRowLines(realRow)].join('');\r\n      });\r\n      return rowsInXML.join('');\r\n    }\r\n\r\n    function* renderRowLines(row) {\r\n      // PivotCache Record: http://www.datypic.com/sc/ooxml/e-ssml_r-1.html\r\n      // Note: pretty-printing this for now to ease debugging.\r\n      yield '\\n  <r>';\r\n      for (const [index, cellValue] of row.entries()) {\r\n        yield '\\n    ';\r\n        yield renderCell(cellValue, cacheFields[index].sharedItems);\r\n      }\r\n      yield '\\n  </r>';\r\n    }\r\n\r\n    function renderCell(value, sharedItems) {\r\n      // no shared items\r\n      // --------------------------------------------------\r\n      if (sharedItems === null) {\r\n        if (Number.isFinite(value)) {\r\n          // Numeric value: http://www.datypic.com/sc/ooxml/e-ssml_n-2.html\r\n          return `<n v=\"${value}\" />`;\r\n        }\r\n          // Character Value: http://www.datypic.com/sc/ooxml/e-ssml_s-2.html\r\n          return `<s v=\"${value}\" />`;\r\n        \r\n      }\r\n\r\n      // shared items\r\n      // --------------------------------------------------\r\n      const sharedItemsIndex = sharedItems.indexOf(value);\r\n      if (sharedItemsIndex < 0) {\r\n        throw new Error(`${JSON.stringify(value)} not in sharedItems ${JSON.stringify(sharedItems)}`);\r\n      }\r\n      // Shared Items Index: http://www.datypic.com/sc/ooxml/e-ssml_x-9.html\r\n      return `<x v=\"${sharedItemsIndex}\" />`;\r\n    }\r\n  }\r\n\r\n  parseOpen(node) {\r\n    // TK\r\n  }\r\n\r\n  parseText(text) {\r\n    // TK\r\n  }\r\n\r\n  parseClose(name) {\r\n    // TK\r\n  }\r\n\r\n  reconcile(model, options) {\r\n    // TK\r\n  }\r\n}\r\n\r\nPivotCacheRecordsXform.PIVOT_CACHE_RECORDS_ATTRIBUTES = {\r\n  xmlns: 'http://schemas.openxmlformats.org/spreadsheetml/2006/main',\r\n  'xmlns:r': 'http://schemas.openxmlformats.org/officeDocument/2006/relationships',\r\n  'xmlns:mc': 'http://schemas.openxmlformats.org/markup-compatibility/2006',\r\n  'mc:Ignorable': 'xr',\r\n  'xmlns:xr': 'http://schemas.microsoft.com/office/spreadsheetml/2014/revision',\r\n};\r\n\r\nmodule.exports = PivotCacheRecordsXform;\r\n"],"mappings":";;;;;;;AAAA,MAAMA,SAAS,GAAGC,OAAO,CAAC,2BAA2B,CAAC;AAEtD,MAAMC,SAAS,GAAGD,OAAO,CAAC,eAAe,CAAC;AAE1C,MAAME,sBAAsB,SAASD,SAAS,CAAC;EAC7CE,WAAWA,CAAA,EAAG;IACZ,KAAK,CAAC,CAAC;IAEP,IAAI,CAACC,GAAG,GAAG,CAAC,CAAC;EACf;EAEAC,OAAOA,CAACC,KAAK,EAAE;IACb;EAAA;EAGF,IAAIC,GAAGA,CAAA,EAAG;IACR;IACA,OAAO,mBAAmB;EAC5B;EAEAC,MAAMA,CAACC,SAAS,EAAEH,KAAK,EAAE;IACvB,MAAM;MAACI,WAAW;MAAEC;IAAW,CAAC,GAAGL,KAAK;IACxC,MAAMM,cAAc,GAAGF,WAAW,CAACG,cAAc,CAAC,CAAC,CAACC,KAAK,CAAC,CAAC,CAAC;IAE5DL,SAAS,CAACM,OAAO,CAAChB,SAAS,CAACiB,gBAAgB,CAAC;IAC7CP,SAAS,CAACQ,QAAQ,CAAC,IAAI,CAACV,GAAG,EAAAW,aAAA,CAAAA,aAAA,KACtBhB,sBAAsB,CAACiB,8BAA8B;MACxDC,KAAK,EAAER,cAAc,CAACS;IAAM,EAC7B,CAAC;IACFZ,SAAS,CAACa,QAAQ,CAACC,WAAW,CAAC,CAAC,CAAC;IACjCd,SAAS,CAACe,SAAS,CAAC,CAAC;;IAErB;;IAEA,SAASD,WAAWA,CAAA,EAAG;MACrB,MAAME,SAAS,GAAGb,cAAc,CAACR,GAAG,CAACsB,GAAG,IAAI;QAC1C,MAAMC,OAAO,GAAGD,GAAG,CAACZ,KAAK,CAAC,CAAC,CAAC;QAC5B,OAAO,CAAC,GAAGc,cAAc,CAACD,OAAO,CAAC,CAAC,CAACE,IAAI,CAAC,EAAE,CAAC;MAC9C,CAAC,CAAC;MACF,OAAOJ,SAAS,CAACI,IAAI,CAAC,EAAE,CAAC;IAC3B;IAEA,UAAUD,cAAcA,CAACF,GAAG,EAAE;MAC5B;MACA;MACA,MAAM,SAAS;MACf,KAAK,MAAM,CAACI,KAAK,EAAEC,SAAS,CAAC,IAAIL,GAAG,CAACM,OAAO,CAAC,CAAC,EAAE;QAC9C,MAAM,QAAQ;QACd,MAAMC,UAAU,CAACF,SAAS,EAAEpB,WAAW,CAACmB,KAAK,CAAC,CAACI,WAAW,CAAC;MAC7D;MACA,MAAM,UAAU;IAClB;IAEA,SAASD,UAAUA,CAACE,KAAK,EAAED,WAAW,EAAE;MACtC;MACA;MACA,IAAIA,WAAW,KAAK,IAAI,EAAE;QACxB,IAAIE,MAAM,CAACC,QAAQ,CAACF,KAAK,CAAC,EAAE;UAC1B;UACA,iBAAAG,MAAA,CAAgBH,KAAK;QACvB;QACE;QACA,iBAAAG,MAAA,CAAgBH,KAAK;MAEzB;;MAEA;MACA;MACA,MAAMI,gBAAgB,GAAGL,WAAW,CAACM,OAAO,CAACL,KAAK,CAAC;MACnD,IAAII,gBAAgB,GAAG,CAAC,EAAE;QACxB,MAAM,IAAIE,KAAK,IAAAH,MAAA,CAAII,IAAI,CAACC,SAAS,CAACR,KAAK,CAAC,0BAAAG,MAAA,CAAuBI,IAAI,CAACC,SAAS,CAACT,WAAW,CAAC,CAAE,CAAC;MAC/F;MACA;MACA,iBAAAI,MAAA,CAAgBC,gBAAgB;IAClC;EACF;EAEAK,SAASA,CAACC,IAAI,EAAE;IACd;EAAA;EAGFC,SAASA,CAACC,IAAI,EAAE;IACd;EAAA;EAGFC,UAAUA,CAACC,IAAI,EAAE;IACf;EAAA;EAGFC,SAASA,CAAC5C,KAAK,EAAE6C,OAAO,EAAE;IACxB;EAAA;AAEJ;AAEAjD,sBAAsB,CAACiB,8BAA8B,GAAG;EACtDiC,KAAK,EAAE,2DAA2D;EAClE,SAAS,EAAE,qEAAqE;EAChF,UAAU,EAAE,6DAA6D;EACzE,cAAc,EAAE,IAAI;EACpB,UAAU,EAAE;AACd,CAAC;AAEDC,MAAM,CAACC,OAAO,GAAGpD,sBAAsB","ignoreList":[]}
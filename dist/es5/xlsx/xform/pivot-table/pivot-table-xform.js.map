{"version":3,"file":"pivot-table-xform.js","names":["XmlStream","require","BaseXform","PivotTableXform","constructor","map","prepare","model","tag","render","xmlStream","rows","columns","values","metric","cacheFields","cacheId","openXml","StdDocAttributes","openNode","_objectSpread","PIVOT_TABLE_ATTRIBUTES","name","applyNumberFormats","applyBorderFormats","applyFontFormats","applyPatternFormats","applyAlignmentFormats","applyWidthHeightFormats","dataCaption","updatedVersion","minRefreshableVersion","useAutoFormatting","itemPrintTitles","createdVersion","indent","compact","compactData","multipleFieldFilters","writeXml","concat","length","renderPivotFields","rowIndex","join","columnIndex","closeNode","parseOpen","node","parseText","text","parseClose","reconcile","options","pivotTable","cacheField","fieldIndex","fieldType","indexOf","renderPivotField","sharedItems","defaultAttributes","axis","item","index","xmlns","module","exports"],"sources":["../../../../../lib/xlsx/xform/pivot-table/pivot-table-xform.js"],"sourcesContent":["const XmlStream = require('../../../utils/xml-stream');\r\nconst BaseXform = require('../base-xform');\r\n\r\nclass PivotTableXform extends BaseXform {\r\n  constructor() {\r\n    super();\r\n\r\n    this.map = {};\r\n  }\r\n\r\n  prepare(model) {\r\n    // TK\r\n  }\r\n\r\n  get tag() {\r\n    // http://www.datypic.com/sc/ooxml/e-ssml_pivotTableDefinition.html\r\n    return 'pivotTableDefinition';\r\n  }\r\n\r\n  render(xmlStream, model) {\r\n    // eslint-disable-next-line no-unused-vars\r\n    const {rows, columns, values, metric, cacheFields, cacheId} = model;\r\n\r\n    // Examples\r\n    // --------\r\n    // rows: [0, 1], // only 2 items possible for now\r\n    // columns: [2], // only 1 item possible for now\r\n    // values: [4], // only 1 item possible for now\r\n    // metric: 'sum', // only 'sum' possible for now\r\n    //\r\n    // the numbers are indices into `cacheFields`.\r\n\r\n    xmlStream.openXml(XmlStream.StdDocAttributes);\r\n    xmlStream.openNode(this.tag, {\r\n      ...PivotTableXform.PIVOT_TABLE_ATTRIBUTES,\r\n      'xr:uid': '{267EE50F-B116-784D-8DC2-BA77DE3F4F4A}',\r\n      name: 'PivotTable2',\r\n      cacheId,\r\n      applyNumberFormats: '0',\r\n      applyBorderFormats: '0',\r\n      applyFontFormats: '0',\r\n      applyPatternFormats: '0',\r\n      applyAlignmentFormats: '0',\r\n      applyWidthHeightFormats: '1',\r\n      dataCaption: 'Values',\r\n      updatedVersion: '8',\r\n      minRefreshableVersion: '3',\r\n      useAutoFormatting: '1',\r\n      itemPrintTitles: '1',\r\n      createdVersion: '8',\r\n      indent: '0',\r\n      compact: '0',\r\n      compactData: '0',\r\n      multipleFieldFilters: '0',\r\n    });\r\n\r\n    // Note: keeping this pretty-printed and verbose for now to ease debugging.\r\n    //\r\n    // location: ref=\"A3:E15\"\r\n    // pivotFields\r\n    // rowFields and rowItems\r\n    // colFields and colItems\r\n    // dataFields\r\n    // pivotTableStyleInfo\r\n    xmlStream.writeXml(`\r\n      <location ref=\"A3:E15\" firstHeaderRow=\"1\" firstDataRow=\"2\" firstDataCol=\"1\" />\r\n      <pivotFields count=\"${cacheFields.length}\">\r\n        ${renderPivotFields(model)}\r\n      </pivotFields>\r\n      <rowFields count=\"${rows.length}\">\r\n        ${rows.map(rowIndex => `<field x=\"${rowIndex}\" />`).join('\\n    ')}\r\n      </rowFields>\r\n      <rowItems count=\"1\">\r\n        <i t=\"grand\"><x /></i>\r\n      </rowItems>\r\n      <colFields count=\"${columns.length}\">\r\n        ${columns.map(columnIndex => `<field x=\"${columnIndex}\" />`).join('\\n    ')}\r\n      </colFields>\r\n      <colItems count=\"1\">\r\n        <i t=\"grand\"><x /></i>\r\n      </colItems>\r\n      <dataFields count=\"${values.length}\">\r\n        <dataField\r\n          name=\"Sum of ${cacheFields[values[0]].name}\"\r\n          fld=\"${values[0]}\"\r\n          baseField=\"0\"\r\n          baseItem=\"0\"\r\n        />\r\n      </dataFields>\r\n      <pivotTableStyleInfo\r\n        name=\"PivotStyleLight16\"\r\n        showRowHeaders=\"1\"\r\n        showColHeaders=\"1\"\r\n        showRowStripes=\"0\"\r\n        showColStripes=\"0\"\r\n        showLastColumn=\"1\"\r\n      />\r\n      <extLst>\r\n        <ext\r\n          uri=\"{962EF5D1-5CA2-4c93-8EF4-DBF5C05439D2}\"\r\n          xmlns:x14=\"http://schemas.microsoft.com/office/spreadsheetml/2009/9/main\"\r\n        >\r\n          <x14:pivotTableDefinition\r\n            hideValuesRow=\"1\"\r\n            xmlns:xm=\"http://schemas.microsoft.com/office/excel/2006/main\"\r\n          />\r\n        </ext>\r\n        <ext\r\n          uri=\"{747A6164-185A-40DC-8AA5-F01512510D54}\"\r\n          xmlns:xpdl=\"http://schemas.microsoft.com/office/spreadsheetml/2016/pivotdefaultlayout\"\r\n        >\r\n          <xpdl:pivotTableDefinition16\r\n            EnabledSubtotalsDefault=\"0\"\r\n            SubtotalsOnTopDefault=\"0\"\r\n          />\r\n        </ext>\r\n      </extLst>\r\n    `);\r\n\r\n    xmlStream.closeNode();\r\n  }\r\n\r\n  parseOpen(node) {\r\n    // TK\r\n  }\r\n\r\n  parseText(text) {\r\n    // TK\r\n  }\r\n\r\n  parseClose(name) {\r\n    // TK\r\n  }\r\n\r\n  reconcile(model, options) {\r\n    // TK\r\n  }\r\n}\r\n\r\n// Helpers\r\n\r\nfunction renderPivotFields(pivotTable) {\r\n  /* eslint-disable no-nested-ternary */\r\n  return pivotTable.cacheFields\r\n    .map((cacheField, fieldIndex) => {\r\n      const fieldType =\r\n        pivotTable.rows.indexOf(fieldIndex) >= 0\r\n          ? 'row'\r\n          : pivotTable.columns.indexOf(fieldIndex) >= 0\r\n          ? 'column'\r\n          : pivotTable.values.indexOf(fieldIndex) >= 0\r\n          ? 'value'\r\n          : null;\r\n      return renderPivotField(fieldType, cacheField.sharedItems);\r\n    })\r\n    .join('');\r\n}\r\n\r\nfunction renderPivotField(fieldType, sharedItems) {\r\n  // fieldType: 'row', 'column', 'value', null\r\n\r\n  const defaultAttributes = 'compact=\"0\" outline=\"0\" showAll=\"0\" defaultSubtotal=\"0\"';\r\n\r\n  if (fieldType === 'row' || fieldType === 'column') {\r\n    const axis = fieldType === 'row' ? 'axisRow' : 'axisCol';\r\n    return `\r\n      <pivotField axis=\"${axis}\" ${defaultAttributes}>\r\n        <items count=\"${sharedItems.length + 1}\">\r\n          ${sharedItems.map((item, index) => `<item x=\"${index}\" />`).join('\\n              ')}\r\n        </items>\r\n      </pivotField>\r\n    `;\r\n  }\r\n  return `\r\n    <pivotField\r\n      ${fieldType === 'value' ? 'dataField=\"1\"' : ''}\r\n      ${defaultAttributes}\r\n    />\r\n  `;\r\n}\r\n\r\nPivotTableXform.PIVOT_TABLE_ATTRIBUTES = {\r\n  xmlns: 'http://schemas.openxmlformats.org/spreadsheetml/2006/main',\r\n  'xmlns:mc': 'http://schemas.openxmlformats.org/markup-compatibility/2006',\r\n  'mc:Ignorable': 'xr',\r\n  'xmlns:xr': 'http://schemas.microsoft.com/office/spreadsheetml/2014/revision',\r\n};\r\n\r\nmodule.exports = PivotTableXform;\r\n"],"mappings":"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","ignoreList":[]}
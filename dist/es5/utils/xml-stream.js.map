{"version":3,"file":"xml-stream.js","names":["_","require","utils","OPEN_ANGLE","CLOSE_ANGLE","OPEN_ANGLE_SLASH","CLOSE_SLASH_ANGLE","pushAttribute","xml","name","value","push","concat","xmlEncode","toString","pushAttributes","attributes","tmp","each","undefined","join","XmlStream","constructor","_xml","_stack","_rollbacks","tos","length","cursor","openXml","docAttributes","openNode","parent","open","leaf","addAttribute","Error","addAttributes","attrs","writeText","text","writeXml","closeNode","node","pop","leafNode","closeAll","addRollback","stack","commit","rollback","r","splice","StdDocAttributes","version","encoding","standalone","module","exports"],"sources":["../../../lib/utils/xml-stream.js"],"sourcesContent":["const _ = require('./under-dash');\r\n\r\nconst utils = require('./utils');\r\n\r\n// constants\r\nconst OPEN_ANGLE = '<';\r\nconst CLOSE_ANGLE = '>';\r\nconst OPEN_ANGLE_SLASH = '</';\r\nconst CLOSE_SLASH_ANGLE = '/>';\r\n\r\nfunction pushAttribute(xml, name, value) {\r\n  xml.push(` ${name}=\"${utils.xmlEncode(value.toString())}\"`);\r\n}\r\nfunction pushAttributes(xml, attributes) {\r\n  if (attributes) {\r\n    const tmp = [];\r\n    _.each(attributes, (value, name) => {\r\n      if (value !== undefined) {\r\n        pushAttribute(tmp, name, value);\r\n      }\r\n    });\r\n    xml.push(tmp.join(\"\"));\r\n  }\r\n}\r\n\r\nclass XmlStream {\r\n  constructor() {\r\n    this._xml = [];\r\n    this._stack = [];\r\n    this._rollbacks = [];\r\n  }\r\n\r\n  get tos() {\r\n    return this._stack.length ? this._stack[this._stack.length - 1] : undefined;\r\n  }\r\n\r\n  get cursor() {\r\n    // handy way to track whether anything has been added\r\n    return this._xml.length;\r\n  }\r\n\r\n  openXml(docAttributes) {\r\n    const xml = this._xml;\r\n    // <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\r\n    xml.push('<?xml');\r\n    pushAttributes(xml, docAttributes);\r\n    xml.push('?>\\n');\r\n  }\r\n\r\n  openNode(name, attributes) {\r\n    const parent = this.tos;\r\n    const xml = this._xml;\r\n    if (parent && this.open) {\r\n      xml.push(CLOSE_ANGLE);\r\n    }\r\n\r\n    this._stack.push(name);\r\n\r\n    // start streaming node\r\n    xml.push(OPEN_ANGLE);\r\n    xml.push(name);\r\n    pushAttributes(xml, attributes);\r\n    this.leaf = true;\r\n    this.open = true;\r\n  }\r\n\r\n  addAttribute(name, value) {\r\n    if (!this.open) {\r\n      throw new Error('Cannot write attributes to node if it is not open');\r\n    }\r\n    if (value !== undefined) {\r\n      pushAttribute(this._xml, name, value);\r\n    }\r\n  }\r\n\r\n  addAttributes(attrs) {\r\n    if (!this.open) {\r\n      throw new Error('Cannot write attributes to node if it is not open');\r\n    }\r\n    pushAttributes(this._xml, attrs);\r\n  }\r\n\r\n  writeText(text) {\r\n    const xml = this._xml;\r\n    if (this.open) {\r\n      xml.push(CLOSE_ANGLE);\r\n      this.open = false;\r\n    }\r\n    this.leaf = false;\r\n    xml.push(utils.xmlEncode(text.toString()));\r\n  }\r\n\r\n  writeXml(xml) {\r\n    if (this.open) {\r\n      this._xml.push(CLOSE_ANGLE);\r\n      this.open = false;\r\n    }\r\n    this.leaf = false;\r\n    this._xml.push(xml);\r\n  }\r\n\r\n  closeNode() {\r\n    const node = this._stack.pop();\r\n    const xml = this._xml;\r\n    if (this.leaf) {\r\n      xml.push(CLOSE_SLASH_ANGLE);\r\n    } else {\r\n      xml.push(OPEN_ANGLE_SLASH);\r\n      xml.push(node);\r\n      xml.push(CLOSE_ANGLE);\r\n    }\r\n    this.open = false;\r\n    this.leaf = false;\r\n  }\r\n\r\n  leafNode(name, attributes, text) {\r\n    this.openNode(name, attributes);\r\n    if (text !== undefined) {\r\n      // zeros need to be written\r\n      this.writeText(text);\r\n    }\r\n    this.closeNode();\r\n  }\r\n\r\n  closeAll() {\r\n    while (this._stack.length) {\r\n      this.closeNode();\r\n    }\r\n  }\r\n\r\n  addRollback() {\r\n    this._rollbacks.push({\r\n      xml: this._xml.length,\r\n      stack: this._stack.length,\r\n      leaf: this.leaf,\r\n      open: this.open,\r\n    });\r\n    return this.cursor;\r\n  }\r\n\r\n  commit() {\r\n    this._rollbacks.pop();\r\n  }\r\n\r\n  rollback() {\r\n    const r = this._rollbacks.pop();\r\n    if (this._xml.length > r.xml) {\r\n      this._xml.splice(r.xml, this._xml.length - r.xml);\r\n    }\r\n    if (this._stack.length > r.stack) {\r\n      this._stack.splice(r.stack, this._stack.length - r.stack);\r\n    }\r\n    this.leaf = r.leaf;\r\n    this.open = r.open;\r\n  }\r\n\r\n  get xml() {\r\n    this.closeAll();\r\n    return this._xml.join('');\r\n  }\r\n}\r\n\r\nXmlStream.StdDocAttributes = {\r\n  version: '1.0',\r\n  encoding: 'UTF-8',\r\n  standalone: 'yes',\r\n};\r\n\r\nmodule.exports = XmlStream;\r\n"],"mappings":"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","ignoreList":[]}
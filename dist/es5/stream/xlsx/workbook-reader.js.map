{"version":3,"file":"workbook-reader.js","names":["fs","require","EventEmitter","PassThrough","Readable","nodeStream","unzip","tmp","iterateStream","parseSax","StyleManager","WorkbookXform","RelationshipsXform","WorksheetReader","HyperlinkReader","setGracefulCleanup","WorkbookReader","constructor","input","options","arguments","length","undefined","_objectSpread","worksheets","sharedStrings","hyperlinks","styles","entries","init","_getStream","createReadStream","Error","concat","read","_iteratorAbruptCompletion","_didIteratorError","_iteratorError","_iterator","_asyncIterator","parse","_step","next","done","eventType","value","emit","err","return","error","Symbol","asyncIterator","_this","_wrapAsyncGenerator","_iteratorAbruptCompletion2","_didIteratorError2","_iteratorError2","_iterator2","_step2","_awaitAsyncGenerator","_this2","stream","zip","Parse","forceStream","pipe","waitingWorkSheets","_iteratorAbruptCompletion3","_didIteratorError3","_iteratorError3","_iterator3","_step3","entry","match","sheetNo","path","_parseRels","_parseWorkbook","_asyncGeneratorDelegate","_parseSharedStrings","_parseStyles","workbookRels","_parseWorksheet","Promise","resolve","reject","file","fd","tempFileCleanupCallback","push","tempStream","createWriteStream","on","_parseHyperlinks","autodrain","fileStream","_emitEntry","payload","xform","parseStream","type","workbook","properties","map","workbookPr","model","_this3","text","richText","index","font","_iteratorAbruptCompletion4","_didIteratorError4","_iteratorError4","_iterator4","_step4","events","node","name","bold","charset","parseInt","attributes","color","rgb","argb","val","theme","family","italic","outline","size","underline","vertAlign","iterator","id","worksheetReader","matchingRel","find","rel","Target","matchingSheet","sheets","sheet","rId","Id","state","_this4","hyperlinksReader","Object","keys","hyperlinkRelationships","Options","module","exports"],"sources":["../../../../lib/stream/xlsx/workbook-reader.js"],"sourcesContent":["const fs = require('fs');\r\nconst {EventEmitter} = require('events');\r\nconst {PassThrough, Readable} = require('readable-stream');\r\nconst nodeStream = require('stream');\r\nconst unzip = require('unzipper');\r\nconst tmp = require('tmp');\r\nconst iterateStream = require('../../utils/iterate-stream');\r\nconst parseSax = require('../../utils/parse-sax');\r\n\r\nconst StyleManager = require('../../xlsx/xform/style/styles-xform');\r\nconst WorkbookXform = require('../../xlsx/xform/book/workbook-xform');\r\nconst RelationshipsXform = require('../../xlsx/xform/core/relationships-xform');\r\n\r\nconst WorksheetReader = require('./worksheet-reader');\r\nconst HyperlinkReader = require('./hyperlink-reader');\r\n\r\ntmp.setGracefulCleanup();\r\n\r\nclass WorkbookReader extends EventEmitter {\r\n  constructor(input, options = {}) {\r\n    super();\r\n\r\n    this.input = input;\r\n\r\n    this.options = {\r\n      worksheets: 'emit',\r\n      sharedStrings: 'cache',\r\n      hyperlinks: 'ignore',\r\n      styles: 'ignore',\r\n      entries: 'ignore',\r\n      ...options,\r\n    };\r\n\r\n    this.styles = new StyleManager();\r\n    this.styles.init();\r\n  }\r\n\r\n  _getStream(input) {\r\n    if (input instanceof nodeStream.Readable || input instanceof Readable) {\r\n      return input;\r\n    }\r\n    if (typeof input === 'string') {\r\n      return fs.createReadStream(input);\r\n    }\r\n    throw new Error(`Could not recognise input: ${input}`);\r\n  }\r\n\r\n  async read(input, options) {\r\n    try {\r\n      for await (const {eventType, value} of this.parse(input, options)) {\r\n        switch (eventType) {\r\n          case 'shared-strings':\r\n            this.emit(eventType, value);\r\n            break;\r\n          case 'worksheet':\r\n            this.emit(eventType, value);\r\n            await value.read();\r\n            break;\r\n          case 'hyperlinks':\r\n            this.emit(eventType, value);\r\n            break;\r\n        }\r\n      }\r\n      this.emit('end');\r\n      this.emit('finished');\r\n    } catch (error) {\r\n      this.emit('error', error);\r\n    }\r\n  }\r\n\r\n  async *[Symbol.asyncIterator]() {\r\n    for await (const {eventType, value} of this.parse()) {\r\n      if (eventType === 'worksheet') {\r\n        yield value;\r\n      }\r\n    }\r\n  }\r\n\r\n  async *parse(input, options) {\r\n    if (options) this.options = options;\r\n    const stream = (this.stream = this._getStream(input || this.input));\r\n    const zip = unzip.Parse({forceStream: true});\r\n    stream.pipe(zip);\r\n\r\n    // worksheets, deferred for parsing after shared strings reading\r\n    const waitingWorkSheets = [];\r\n\r\n    for await (const entry of iterateStream(zip)) {\r\n      let match;\r\n      let sheetNo;\r\n      switch (entry.path) {\r\n        case '_rels/.rels':\r\n          break;\r\n        case 'xl/_rels/workbook.xml.rels':\r\n          await this._parseRels(entry);\r\n          break;\r\n        case 'xl/workbook.xml':\r\n          await this._parseWorkbook(entry);\r\n          break;\r\n        case 'xl/sharedStrings.xml':\r\n          yield* this._parseSharedStrings(entry);\r\n          break;\r\n        case 'xl/styles.xml':\r\n          await this._parseStyles(entry);\r\n          break;\r\n        default:\r\n          if (entry.path.match(/xl\\/worksheets\\/sheet\\d+[.]xml/)) {\r\n            match = entry.path.match(/xl\\/worksheets\\/sheet(\\d+)[.]xml/);\r\n            sheetNo = match[1];\r\n            if (this.sharedStrings && this.workbookRels) {\r\n              yield* this._parseWorksheet(iterateStream(entry), sheetNo);\r\n            } else {\r\n              // create temp file for each worksheet\r\n              await new Promise((resolve, reject) => {\r\n                tmp.file((err, path, fd, tempFileCleanupCallback) => {\r\n                  if (err) {\r\n                    return reject(err);\r\n                  }\r\n                  waitingWorkSheets.push({sheetNo, path, tempFileCleanupCallback});\r\n\r\n                  const tempStream = fs.createWriteStream(path);\r\n                  tempStream.on('error', reject);\r\n                  entry.pipe(tempStream);\r\n                  return tempStream.on('finish', () => {\r\n                    return resolve();\r\n                  });\r\n                });\r\n              });\r\n            }\r\n          } else if (entry.path.match(/xl\\/worksheets\\/_rels\\/sheet\\d+[.]xml.rels/)) {\r\n            match = entry.path.match(/xl\\/worksheets\\/_rels\\/sheet(\\d+)[.]xml.rels/);\r\n            sheetNo = match[1];\r\n            yield* this._parseHyperlinks(iterateStream(entry), sheetNo);\r\n          }\r\n          break;\r\n      }\r\n      entry.autodrain();\r\n    }\r\n\r\n    for (const {sheetNo, path, tempFileCleanupCallback} of waitingWorkSheets) {\r\n      let fileStream = fs.createReadStream(path);\r\n      // TODO: Remove once node v8 is deprecated\r\n      // Detect and upgrade old fileStreams\r\n      if (!fileStream[Symbol.asyncIterator]) {\r\n        fileStream = fileStream.pipe(new PassThrough());\r\n      }\r\n      yield* this._parseWorksheet(fileStream, sheetNo);\r\n      tempFileCleanupCallback();\r\n    }\r\n  }\r\n\r\n  _emitEntry(payload) {\r\n    if (this.options.entries === 'emit') {\r\n      this.emit('entry', payload);\r\n    }\r\n  }\r\n\r\n  async _parseRels(entry) {\r\n    const xform = new RelationshipsXform();\r\n    this.workbookRels = await xform.parseStream(iterateStream(entry));\r\n  }\r\n\r\n  async _parseWorkbook(entry) {\r\n    this._emitEntry({type: 'workbook'});\r\n\r\n    const workbook = new WorkbookXform();\r\n    await workbook.parseStream(iterateStream(entry));\r\n\r\n    this.properties = workbook.map.workbookPr;\r\n    this.model = workbook.model;\r\n  }\r\n\r\n  async *_parseSharedStrings(entry) {\r\n    this._emitEntry({type: 'shared-strings'});\r\n    switch (this.options.sharedStrings) {\r\n      case 'cache':\r\n        this.sharedStrings = [];\r\n        break;\r\n      case 'emit':\r\n        break;\r\n      default:\r\n        return;\r\n    }\r\n\r\n    let text = null;\r\n    let richText = [];\r\n    let index = 0;\r\n    let font = null;\r\n    for await (const events of parseSax(iterateStream(entry))) {\r\n      for (const {eventType, value} of events) {\r\n        if (eventType === 'opentag') {\r\n          const node = value;\r\n          switch (node.name) {\r\n            case 'b':\r\n              font = font || {};\r\n              font.bold = true;\r\n              break;\r\n            case 'charset':\r\n              font = font || {};\r\n              font.charset = parseInt(node.attributes.charset, 10);\r\n              break;\r\n            case 'color':\r\n              font = font || {};\r\n              font.color = {};\r\n              if (node.attributes.rgb) {\r\n                font.color.argb = node.attributes.argb;\r\n              }\r\n              if (node.attributes.val) {\r\n                font.color.argb = node.attributes.val;\r\n              }\r\n              if (node.attributes.theme) {\r\n                font.color.theme = node.attributes.theme;\r\n              }\r\n              break;\r\n            case 'family':\r\n              font = font || {};\r\n              font.family = parseInt(node.attributes.val, 10);\r\n              break;\r\n            case 'i':\r\n              font = font || {};\r\n              font.italic = true;\r\n              break;\r\n            case 'outline':\r\n              font = font || {};\r\n              font.outline = true;\r\n              break;\r\n            case 'rFont':\r\n              font = font || {};\r\n              font.name = node.value;\r\n              break;\r\n            case 'si':\r\n              font = null;\r\n              richText = [];\r\n              text = null;\r\n              break;\r\n            case 'sz':\r\n              font = font || {};\r\n              font.size = parseInt(node.attributes.val, 10);\r\n              break;\r\n            case 'strike':\r\n              break;\r\n            case 't':\r\n              text = null;\r\n              break;\r\n            case 'u':\r\n              font = font || {};\r\n              font.underline = true;\r\n              break;\r\n            case 'vertAlign':\r\n              font = font || {};\r\n              font.vertAlign = node.attributes.val;\r\n              break;\r\n          }\r\n        } else if (eventType === 'text') {\r\n          text = text ? text + value : value;\r\n        } else if (eventType === 'closetag') {\r\n          const node = value;\r\n          switch (node.name) {\r\n            case 'r':\r\n              richText.push({\r\n                font,\r\n                text,\r\n              });\r\n\r\n              font = null;\r\n              text = null;\r\n              break;\r\n            case 'si':\r\n              if (this.options.sharedStrings === 'cache') {\r\n                this.sharedStrings.push(richText.length ? {richText} : text);\r\n              } else if (this.options.sharedStrings === 'emit') {\r\n                yield {index: index++, text: richText.length ? {richText} : text};\r\n              }\r\n\r\n              richText = [];\r\n              font = null;\r\n              text = null;\r\n              break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  async _parseStyles(entry) {\r\n    this._emitEntry({type: 'styles'});\r\n    if (this.options.styles === 'cache') {\r\n      this.styles = new StyleManager();\r\n      await this.styles.parseStream(iterateStream(entry));\r\n    }\r\n  }\r\n\r\n  *_parseWorksheet(iterator, sheetNo) {\r\n    this._emitEntry({type: 'worksheet', id: sheetNo});\r\n    const worksheetReader = new WorksheetReader({\r\n      workbook: this,\r\n      id: sheetNo,\r\n      iterator,\r\n      options: this.options,\r\n    });\r\n\r\n    const matchingRel = (this.workbookRels || []).find(rel => rel.Target === `worksheets/sheet${sheetNo}.xml`);\r\n    const matchingSheet = matchingRel && (this.model.sheets || []).find(sheet => sheet.rId === matchingRel.Id);\r\n    if (matchingSheet) {\r\n      worksheetReader.id = matchingSheet.id;\r\n      worksheetReader.name = matchingSheet.name;\r\n      worksheetReader.state = matchingSheet.state;\r\n    }\r\n    if (this.options.worksheets === 'emit') {\r\n      yield {eventType: 'worksheet', value: worksheetReader};\r\n    }\r\n  }\r\n\r\n  async *_parseHyperlinks(iterator, sheetNo) {\r\n    this._emitEntry({type: 'hyperlinks', id: sheetNo});\r\n    const hyperlinksReader = new HyperlinkReader({\r\n      workbook: this,\r\n      id: sheetNo,\r\n      iterator,\r\n      options: this.options,\r\n    });\r\n\r\n    // Read the hyperlinks first to populate the relationships\r\n    await hyperlinksReader.read();\r\n\r\n    // Store hyperlink relationships by sheet number for worksheet reader to access\r\n    if (hyperlinksReader.hyperlinks && Object.keys(hyperlinksReader.hyperlinks).length > 0) {\r\n      if (!this.hyperlinkRelationships) {\r\n        this.hyperlinkRelationships = {};\r\n      }\r\n      this.hyperlinkRelationships[sheetNo] = hyperlinksReader.hyperlinks;\r\n    }\r\n\r\n    if (this.options.hyperlinks === 'emit') {\r\n      yield {eventType: 'hyperlinks', value: hyperlinksReader};\r\n    }\r\n  }\r\n}\r\n\r\n// for reference - these are the valid values for options\r\nWorkbookReader.Options = {\r\n  worksheets: ['emit', 'ignore'],\r\n  sharedStrings: ['cache', 'emit', 'ignore'],\r\n  hyperlinks: ['cache', 'emit', 'ignore'],\r\n  styles: ['cache', 'ignore'],\r\n  entries: ['emit', 'ignore'],\r\n};\r\n\r\nmodule.exports = WorkbookReader;\r\n"],"mappings":"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","ignoreList":[]}
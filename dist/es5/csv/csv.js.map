{"version":3,"file":"csv.js","names":["fs","require","fastCsv","customParseFormat","utc","dayjs","extend","StreamBuf","exists","SpecialValues","true","false","error","CSV","constructor","workbook","worksheet","readFile","filename","options","Error","concat","stream","createReadStream","read","close","Promise","resolve","reject","addWorksheet","sheetName","dateFormats","map","datum","datumNumber","Number","isNaN","Infinity","dt","reduce","matchingDate","currentDateFormat","dayjsObj","isValid","Date","valueOf","special","undefined","csvStream","parse","parserOptions","on","data","addRow","emit","pipe","createInputStream","write","getWorksheet","sheetId","format","formatterOptions","dateFormat","dateUTC","value","text","hyperlink","formula","result","JSON","stringify","includeEmptyRows","lastRow","eachRow","row","rowNumber","values","shift","end","writeFile","streamOptions","encoding","createWriteStream","writeBuffer","module","exports"],"sources":["../../../lib/csv/csv.js"],"sourcesContent":["const fs = require('fs');\r\nconst fastCsv = require('fast-csv');\r\nconst customParseFormat = require('dayjs/plugin/customParseFormat');\r\nconst utc = require('dayjs/plugin/utc');\r\nconst dayjs = require('dayjs').extend(customParseFormat).extend(utc);\r\nconst StreamBuf = require('../utils/stream-buf');\r\n\r\nconst {\r\n  fs: {exists},\r\n} = require('../utils/utils');\r\n\r\n/* eslint-disable quote-props */\r\nconst SpecialValues = {\r\n  true: true,\r\n  false: false,\r\n  '#N/A': {error: '#N/A'},\r\n  '#REF!': {error: '#REF!'},\r\n  '#NAME?': {error: '#NAME?'},\r\n  '#DIV/0!': {error: '#DIV/0!'},\r\n  '#NULL!': {error: '#NULL!'},\r\n  '#VALUE!': {error: '#VALUE!'},\r\n  '#NUM!': {error: '#NUM!'},\r\n};\r\n/* eslint-ensable quote-props */\r\n\r\nclass CSV {\r\n  constructor(workbook) {\r\n    this.workbook = workbook;\r\n    this.worksheet = null;\r\n  }\r\n\r\n  async readFile(filename, options) {\r\n    options = options || {};\r\n    if (!(await exists(filename))) {\r\n      throw new Error(`File not found: ${filename}`);\r\n    }\r\n    const stream = fs.createReadStream(filename);\r\n    const worksheet = await this.read(stream, options);\r\n    stream.close();\r\n    return worksheet;\r\n  }\r\n\r\n  read(stream, options) {\r\n    options = options || {};\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const worksheet = this.workbook.addWorksheet(options.sheetName);\r\n\r\n      const dateFormats = options.dateFormats || [\r\n        'YYYY-MM-DD[T]HH:mm:ssZ',\r\n        'YYYY-MM-DD[T]HH:mm:ss',\r\n        'MM-DD-YYYY',\r\n        'YYYY-MM-DD',\r\n      ];\r\n      const map =\r\n        options.map ||\r\n        function(datum) {\r\n          if (datum === '') {\r\n            return null;\r\n          }\r\n          const datumNumber = Number(datum);\r\n          if (!Number.isNaN(datumNumber) && datumNumber !== Infinity) {\r\n            return datumNumber;\r\n          }\r\n          const dt = dateFormats.reduce((matchingDate, currentDateFormat) => {\r\n            if (matchingDate) {\r\n              return matchingDate;\r\n            }\r\n            const dayjsObj = dayjs(datum, currentDateFormat, true);\r\n            if (dayjsObj.isValid()) {\r\n              return dayjsObj;\r\n            }\r\n            return null;\r\n          }, null);\r\n          if (dt) {\r\n            return new Date(dt.valueOf());\r\n          }\r\n          const special = SpecialValues[datum];\r\n          if (special !== undefined) {\r\n            return special;\r\n          }\r\n          return datum;\r\n        };\r\n\r\n      const csvStream = fastCsv\r\n        .parse(options.parserOptions)\r\n        .on('data', data => {\r\n          worksheet.addRow(data.map(map));\r\n        })\r\n        .on('end', () => {\r\n          csvStream.emit('worksheet', worksheet);\r\n        });\r\n\r\n      csvStream.on('worksheet', resolve).on('error', reject);\r\n\r\n      stream.pipe(csvStream);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @deprecated since version 4.0. You should use `CSV#read` instead. Please follow upgrade instruction: https://github.com/exceljs/exceljs/blob/master/UPGRADE-4.0.md\r\n   */\r\n  createInputStream() {\r\n    throw new Error(\r\n      '`CSV#createInputStream` is deprecated. You should use `CSV#read` instead. This method will be removed in version 5.0. Please follow upgrade instruction: https://github.com/exceljs/exceljs/blob/master/UPGRADE-4.0.md'\r\n    );\r\n  }\r\n\r\n  write(stream, options) {\r\n    return new Promise((resolve, reject) => {\r\n      options = options || {};\r\n      // const encoding = options.encoding || 'utf8';\r\n      // const separator = options.separator || ',';\r\n      // const quoteChar = options.quoteChar || '\\'';\r\n\r\n      const worksheet = this.workbook.getWorksheet(options.sheetName || options.sheetId);\r\n\r\n      const csvStream = fastCsv.format(options.formatterOptions);\r\n      stream.on('finish', () => {\r\n        resolve();\r\n      });\r\n      csvStream.on('error', reject);\r\n      csvStream.pipe(stream);\r\n\r\n      const {dateFormat, dateUTC} = options;\r\n      const map =\r\n        options.map ||\r\n        (value => {\r\n          if (value) {\r\n            if (value.text || value.hyperlink) {\r\n              return value.hyperlink || value.text || '';\r\n            }\r\n            if (value.formula || value.result) {\r\n              return value.result || '';\r\n            }\r\n            if (value instanceof Date) {\r\n              if (dateFormat) {\r\n                return dateUTC\r\n                  ? dayjs.utc(value).format(dateFormat)\r\n                  : dayjs(value).format(dateFormat);\r\n              }\r\n              return dateUTC ? dayjs.utc(value).format() : dayjs(value).format();\r\n            }\r\n            if (value.error) {\r\n              return value.error;\r\n            }\r\n            if (typeof value === 'object') {\r\n              return JSON.stringify(value);\r\n            }\r\n          }\r\n          return value;\r\n        });\r\n\r\n      const includeEmptyRows = options.includeEmptyRows === undefined || options.includeEmptyRows;\r\n      let lastRow = 1;\r\n      if (worksheet) {\r\n        worksheet.eachRow((row, rowNumber) => {\r\n          if (includeEmptyRows) {\r\n            while (lastRow++ < rowNumber - 1) {\r\n              csvStream.write([]);\r\n            }\r\n          }\r\n          const {values} = row;\r\n          values.shift();\r\n          csvStream.write(values.map(map));\r\n          lastRow = rowNumber;\r\n        });\r\n      }\r\n      csvStream.end();\r\n    });\r\n  }\r\n\r\n  writeFile(filename, options) {\r\n    options = options || {};\r\n\r\n    const streamOptions = {\r\n      encoding: options.encoding || 'utf8',\r\n    };\r\n    const stream = fs.createWriteStream(filename, streamOptions);\r\n\r\n    return this.write(stream, options);\r\n  }\r\n\r\n  async writeBuffer(options) {\r\n    const stream = new StreamBuf();\r\n    await this.write(stream, options);\r\n    return stream.read();\r\n  }\r\n}\r\n\r\nmodule.exports = CSV;\r\n"],"mappings":"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","ignoreList":[]}